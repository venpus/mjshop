# AI가 DB·서버 API를 스스로 활용하도록 하는 방법

이 문서는 **AI가 DB와 서버 API를 “학습”해서** 발주·배송 수량(한국도착 완료 수량 등)을 정확히 체크하고 답변하도록 하기 위한 개념과 구현 방법을 정리합니다.

---

## 1. “AI가 학습한다”의 의미 (제약 사항)

- **일반적인 “학습”이 아님**  
  AI(LLM)는 사용자 DB나 API 스키마를 **학습(training)하지 않습니다**.  
  모델은 고정되어 있고, 매 요청마다 **시스템 메시지·도구 결과**만 입력으로 받습니다.

- **실제로 가능한 것**  
  - **컨텍스트로 “참조”하게 하기**: 시스템 메시지·도구 설명에 **용어 정의, 데이터 출처, API 응답 구조**를 넣어 두면, AI는 그 내용을 보고 답변합니다.  
  - **도구(Tool) 호출**: AI가 `get_purchase_orders`, `get_not_arrived_analysis` 같은 도구를 호출하면, 서버가 **실제 DB/뷰**를 조회한 결과를 반환하고, AI는 그 결과만 사용해 답변합니다.

따라서 **“AI가 DB·API를 스스로 학습하게 한다”**는 것은 다음을 의미합니다.

- **DB/API 구조와 의미를 “문서”로 제공**하고  
- **도구 호출 결과만 사용**하도록 지시하며  
- **각 수량·상태가 어떤 테이블/뷰/도구에서 오는지**를 명시하는 것  

입니다.

---

## 2. 한국도착 완료 수량이 “체크하기 어렵다”고 느껴지는 이유

- **AI 입장에서는**  
  - “한국도착 완료 수량”이 **어느 테이블/컬럼/뷰**에서 오는지  
  - **어느 도구**를 호출하면 그 값을 받을 수 있는지  
  가 시스템 메시지에 없으면, 추측하거나 잘못된 출처를 말할 수 있습니다.

- **서버/DB 관점**  
  - 한국도착 완료 수량은 **실제로** 아래 경로로 계산·제공되고 있습니다.  
  - AI가 **이 경로를 설명으로 한 번 읽고**, **해당 도구만 호출**하면 “체크하기 어렵다”는 느낌을 줄일 수 있습니다.

---

## 3. DB·API 구조 요약 (AI 참조용)

### 3.1 한국도착 완료 수량 (arrived_quantity)

| 항목 | 내용 |
|------|------|
| **의미** | 한국에 도착해 입고 처리된 수량. 사용자가 “한국도착일”로 입력한 수량의 합계. |
| **DB 출처** | 뷰 `v_purchase_order_shipping_summary`의 `arrived_quantity` |
| **실제 계산** | 테이블 `packing_list_korea_arrivals`의 `quantity`를, `packing_list_items.purchase_order_id`로 묶어 **발주별 SUM** |
| **관련 테이블** | `packing_list_korea_arrivals` (packing_list_item_id, arrival_date, quantity), `packing_list_items` (purchase_order_id) |

즉, **한국도착 완료 수량 = packing_list_korea_arrivals.quantity 를 packing_list_items 경유로 발주별 합산한 값**입니다.

### 3.2 기타 수량 (뷰 기준)

- **미입고 수량** (unreceived_quantity): `발주 수량 - 업체 출고 수량` (뷰에서 계산)  
- **미발송 수량** (unshipped_quantity): `업체 출고 수량 - 패킹리스트 출고 수량`  
- **배송중 수량** (shipping_quantity): `패킹리스트 출고 수량 - 한국도착 수량`  
- **한국도착 수량** (arrived_quantity): 위 3.1과 동일  

모두 **v_purchase_order_shipping_summary** 또는 이 뷰를 사용하는 리포지토리/서비스를 통해 노출됩니다.

### 3.3 AI가 호출하는 도구와 반환 필드

| 도구 이름 | 용도 | 한국도착 수량 관련 반환 필드 |
|-----------|------|-----------------------------|
| **get_purchase_orders** | 발주 목록 전체 | `한국도착수량`, `미입고수량`, `미발송수량`, `배송중수량` |
| **get_not_arrived_analysis** | 한국 미도착 물품 분석 | `입고수량`(arrived_quantity), `배송중수량`, `한국미도착수량` |

- **한국도착 완료 수량을 “체크”하려면**  
  - 발주 단위로 보려면 → **get_purchase_orders** 호출 후 각 항목의 **한국도착수량** 사용  
  - 미도착 대비 입고 현황을 보려면 → **get_not_arrived_analysis** 호출 후 **입고수량** 사용  

---

## 4. AI가 DB·API를 “스스로 활용”하도록 하는 방법 (구현 관점)

### 4.1 시스템 메시지에 “데이터·API 참조” 블록 넣기 (권장)

- **용어 정의**  
  - 이미 `ORDER_TERMS_DEFINITION` 등으로 “미입고·미발송·배송중·한국도착 완료” 의미를 넣어 두었습니다.

- **추가로 넣을 내용**  
  - **데이터 출처**: “한국도착 완료 수량 = packing_list_korea_arrivals 의 quantity 를 발주별로 합산한 값”  
  - **어느 도구에서 나오는지**: “get_purchase_orders 응답의 한국도착수량, get_not_arrived_analysis 응답의 입고수량”  
  - 필요 시 **다른 수량(미입고·미발송·배송중)**도 “뷰 v_purchase_order_shipping_summary 기준”이라고 한 줄씩 명시  

- **효과**  
  - AI가 “한국도착 완료 수량을 체크해 달라”는 질문을 받았을 때,  
    - 어떤 도구를 호출해야 하는지  
    - 응답의 어떤 필드를 봐야 하는지  
    를 시스템 메시지만 보고 판단할 수 있게 됩니다.  
  - “학습”이 아니라 **매 대화마다 같은 참조 문서를 읽는 것**에 해당합니다.

이 방식은 **서버 코드의 시스템 메시지(ORDER_TERMS_DEFINITION 근처)에 “데이터·API 참조” 블록을 추가**하는 것으로 구현할 수 있습니다. (아래 5절에서 예시 적용)

### 4.2 도구(Tool) 설명에 “응답 필드” 명시

- **현재**  
  - `get_purchase_orders` 등은 “발주 목록 전체 조회” 정도만 설명되어 있고,  
    응답에 `한국도착수량`, `미입고수량` 등이 포함된다는 설명이 없을 수 있습니다.

- **개선**  
  - 각 도구의 `description`에  
    - “응답 항목에 **한국도착수량, 미입고수량, 미발송수량, 배송중수량** 포함”  
    같은 문구를 추가합니다.  
  - AI가 도구 선택 시 “한국도착 수량이 필요하면 get_purchase_orders를 쓰면 된다”를 스스로 추론하기 쉬워집니다.

### 4.3 (선택) 스키마·API 명세를 반환하는 “설명 전용” API

- **개념**  
  - 예: `GET /api/qwen/schema` 또는 `GET /api/qwen/data-dictionary`  
  - 응답에  
    - 주요 엔티티(발주, 패킹리스트, 한국도착일 등)  
    - 수량/상태 필드 이름과 의미  
    - “한국도착 완료 수량 = …” 같은 한 줄 정의  
  를 JSON으로 반환합니다.

- **활용**  
  - **방법 A**: 서버가 AI 호출 전에 이 API를 한 번 호출해 결과를 시스템 메시지에 이어 붙입니다.  
  - **방법 B**: “데이터 사전이 필요할 때만” 호출하는 **도구**를 하나 두고, AI가 필요 시 그 도구를 호출해 스키마/정의를 읽게 합니다.  

- **효과**  
  - 스키마나 용어 정의를 코드와 분리해 두고, API 한 번으로 최신 설명을 AI에게 줄 수 있습니다.  
  - “DB·API를 AI가 스스로 학습한다”기보다는, **“최신 데이터 사전을 매번 불러와서 참조하게 한다”**에 가깝습니다.

### 4.4 (선택) RAG로 문서 검색

- **개념**  
  - 마이그레이션 SQL, API 스펙, 내부 문서를 **벡터 DB**에 넣어 두고,  
  - 사용자 질문과 관련된 문단만 검색해 AI 컨텍스트에 붙입니다.

- **특징**  
  - 문서가 길 때 유용하지만, 구축·운영 비용이 큽니다.  
  - “한국도착 수량” 같은 단일 개념은 **시스템 메시지에 한 블록으로 넣는 것**이 더 단순하고 안정적입니다.

---

## 5. 권장 구현 순서 (요약)

1. **시스템 메시지에 “데이터·API 참조” 블록 추가**  
   - 한국도착 완료 수량의 **DB 출처**(뷰, 테이블, 계산식)  
   - **어느 도구**를 호출하면 **어떤 필드**로 나오는지  
   - (선택) 미입고·미발송·배송중도 같은 방식으로 한 줄씩  

2. **도구 설명 보강**  
   - `get_purchase_orders`: “응답에 한국도착수량, 미입고수량, 미발송수량, 배송중수량 포함”  
   - `get_not_arrived_analysis`: “응답에 입고수량(한국도착 수량), 배송중수량, 한국미도착수량 포함”  

3. **(선택) 스키마/데이터 사전 API**  
   - 나중에 엔티티가 많아지면, 위 내용을 JSON API로 제공하고 시스템 메시지 또는 전용 도구로 넣기  

이렇게 하면 **AI는 DB를 “학습”하지 않지만**,  
**매 요청마다 동일한 “데이터·API 참조”를 읽고**,  
**한국도착 완료 수량을 포함한 수량·상태를 올바른 도구와 필드로 체크**할 수 있습니다.

---

## 6. 이 프로젝트에서의 적용

- **시스템 메시지** (`server/src/controllers/qwenController.ts`)
  - `DATA_AND_API_REFERENCE`: 한국도착 완료 수량의 DB 출처(뷰·테이블), **get_purchase_orders**의 한국도착수량·**get_not_arrived_analysis**의 입고수량 매핑, “한국도착 수량 체크 시 이 도구를 호출한 뒤 해당 필드만 사용” 지시.
  - 에이전트·의도 기반 모두 시스템 메시지에 `ORDER_TERMS_DEFINITION` + `DATA_AND_API_REFERENCE` 포함.

- **도구 설명** (`server/src/services/qwenService.ts`)
  - `get_purchase_orders`: “응답에 미입고수량, 미발송수량, 배송중수량, 한국도착수량 포함. 한국도착 완료 수량 확인 시 이 도구 사용.”
  - `get_not_arrived_analysis`: “응답: 입고수량(한국도착 수량), 배송중수량, 한국미도착수량 …”

- **문서**
  - 본 가이드: `docs/AI_DB_API_LEARNING_GUIDE.md`
